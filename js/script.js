const messageInput = document.querySelector('.message-input');
const chatBody = document.querySelector('.chat-body');
const sendMessageButton = document.getElementById('send-message');
const fileInput = document.getElementById('file-input');
const fileUploadWrapper = document.querySelector('.file-upload-wrapper');
const fileCancelButton = document.querySelector('#file-cancel');
const chatbotToggler = document.getElementById('chatbot-toggler');
const closeChatbot = document.getElementById('close-chatbot');
const addChatBtn = document.getElementById('add-chatbot');
const staticMessage = document.querySelector('#static-message');

// User data object
const userData = {
    message: null,
    file: {
        data: null,
        mime_type: null
    }
}
const initialInputHeight = messageInput.scrollHeight;

// Function to create a message element
const createMessageElement = (content, ...classes) => {
    const div = document.createElement("div");
    div.classList.add("message", ...classes);
    div.innerHTML = content;
    return div;
}

// --- Save and load chat from localStorage ---
const saveChatToStorage = () => {
    localStorage.setItem('chatMessages', chatBody.innerHTML);
}

const loadChatFromStorage = () => {
    const storedChat = localStorage.getItem('chatMessages');
    if (storedChat) {
        chatBody.innerHTML = storedChat;
        chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
    }
}

// --- Save and load chat popup state ---
const saveChatState = () => {
    const isOpen = document.body.classList.contains('show-chatbot');
    localStorage.setItem('chatOpen', isOpen ? 'true' : 'false');
}

const loadChatState = () => {
    const isOpen = localStorage.getItem('chatOpen');
    if (isOpen === 'true') {
        document.body.classList.add('show-chatbot');
    } else {
        document.body.classList.remove('show-chatbot');
    }
}

// --- Handle outgoing messages ---
const handleOutgoingMessage = (e) => {
    e.preventDefault();
    userData.message = messageInput.value.trim();
    if (!userData.message && !userData.file.data) return;
    messageInput.value = "";
    fileUploadWrapper.classList.remove('file-uploaded');
    messageInput.dispatchEvent(new Event('input'));

    // User message
    const messageContent = `<div class="message-text"></div>
                            ${userData.file.data ? `<img src="data:${userData.file.mime_type};base64,${userData.file.data}" class="attachement"/>` : ""}`;
    const outgoingMessageDiv = createMessageElement(messageContent, "user-message");
    outgoingMessageDiv.querySelector(".message-text").innerHTML = userData.message;
    chatBody.appendChild(outgoingMessageDiv);
    chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });

    saveChatToStorage();

    // Bot message with "thinking dots"
    setTimeout(() => {
        const messageContent = `<svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="50" viewBox="0 0 928 1024"
                xml:space="preserve">
                <path opacity="1.11"
                    d="M198.84 483.132c1.693-28.225 3.298-55.976 5.064-83.716 2.146-33.72 4.539-67.426 6.615-101.15 1.636-26.59 2.867-53.204 4.442-79.797 1.073-18.111 2.395-36.208 3.672-54.307.551-7.815 3.777-9.329 10.223-4.687 12.977 9.346 25.855 18.827 38.783 28.242 45.513 33.147 91.09 66.208 136.466 99.542 5.463 4.014 10.62 1.771 15.766 1.032 20.096-2.887 40.133-6.196 60.174-9.462 6.916-1.127 13.588.492 20.327 1.356 19.15 2.456 38.298 4.941 57.42 7.611 3.797.53 6.4-1.246 9.088-3.202 24.655-17.94 49.292-35.903 73.94-53.852 32.856-23.929 65.722-47.845 98.564-71.794 1.661-1.21 3.317-2.064 5.442-2.174 6.055-.314 6.91.481 7.247 6.492 2.058 36.736 4.121 73.471 6.266 110.202 1.59 27.254 3.283 54.503 4.974 81.752 2.279 36.718 4.596 73.434 6.906 110.15.606 9.629 1.264 19.253 1.865 28.881.115 1.85.51 3.584 1.218 5.313a72218 72218 0 0 1 39.647 97.12c10.994 26.988 21.91 54.01 32.971 80.97 1.748 4.262-.099 6.09-3.748 7.542-16.592 6.604-33.933 10.82-50.971 15.98-42.847 12.975-85.795 25.621-128.634 38.623-6.029 1.83-11.82 4.501-17.971 6.044-2.076.52-3.367 1.991-4.734 3.482-21.049 22.96-42.156 45.866-63.184 68.844a11325 11325 0 0 0-47.39 52.141c-1.987 2.2-4.203 3.594-7.07 4.34-10.957 2.853-21.928 5.672-32.786 8.869-7.225 2.126-13.395-1.578-19.951-2.945-7.32-1.526-14.46-3.902-21.715-5.767-2.862-.737-5.124-2.146-7.112-4.32-24.965-27.29-49.973-54.541-74.966-81.806-12.046-13.141-24.107-26.269-36.097-39.46-1.887-2.076-4.207-3.176-6.738-4.087-17.87-6.437-36.292-11.072-54.432-16.625-46.31-14.174-92.74-27.956-139.116-41.915-6.15-1.852-6.772-3.243-4.237-9.492a272459 272459 0 0 1 52.441-129.146c6.204-15.271 12.197-30.634 18.768-45.746 2.666-6.132 2.236-12.333 2.562-19.078m506.143-34.641 56.8 37.037-19.077-311.097-1.256-.155-154.775 196.402c39.598 26.039 78.654 51.72 118.308 77.813M217.063 347.394c-1.365 22.756-2.684 45.515-4.114 68.268-.792 12.615-2.059 25.207-2.577 37.832-.433 10.536-1.776 21.054-1.264 32.622l174.059-114.051-155.556-197.313c-.527 7.048-1.019 12.62-1.348 18.203-1.147 19.433-2.193 38.873-3.36 58.306-1.905 31.725-3.875 63.446-5.84 96.133m414 256.064c-2.316 4.795-4.675 9.57-6.933 14.394-1.454 3.105-3.714 4.93-7.152 5.536-8.68 1.53-17.335 3.208-26 4.826-8.067 1.506-16.134 3.011-24.746 4.62 1.23 1.974 1.922 3.293 2.803 4.47 23.539 31.467 47.132 62.893 70.595 94.416 2.212 2.972 4.14 3.776 7.865 2.654 55.597-16.748 111.251-33.305 166.883-49.939 4.466-1.335 8.864-2.9 14.07-4.614-61.561-35.05-122.848-68.568-183.852-104.096-4.628 9.487-8.915 18.275-13.534 27.733m-385.656 18.52c-34.166 19.242-68.333 38.483-102.718 57.846 2.1 2.092 4.346 2.232 6.362 2.84 22.784 6.872 45.583 13.695 68.375 20.545 34.592 10.396 69.203 20.729 103.744 31.295 4.373 1.338 6.843.53 9.585-3.169 20.738-27.965 41.706-55.759 62.586-83.618 3.354-4.474 6.628-9.007 10.215-13.888-1.966-.601-3.184-1.108-4.452-1.34-15.052-2.77-30.1-5.57-45.177-8.19-4.117-.714-6.802-2.475-8.632-6.465-5.552-12.106-11.648-23.962-17.227-36.056-2.074-4.496-4.205-4.86-8.329-2.39-24.29 14.552-48.895 28.56-74.332 42.59m359.437-70.262c3.991.164 8.025.029 11.96.583 3.295.464 6.16.032 9.167-1.323 38.853-17.5 77.754-34.892 116.599-52.41 3.868-1.745 8.039-3.003 12.15-6.117l-169.91-111.566-13.49 187.613c6.892-4.96 12.936-8.553 18.02-13.196 4.5-4.108 9.063-5.068 15.504-3.584M305.58 434.128l-90.107 59.353c.884.801 1.084 1.094 1.36 1.218q64.023 28.784 128.057 57.543c2.15.966 4.317 1.5 6.77 1.236 5.951-.643 11.94-.953 17.895-1.566 3.534-.363 6.277.625 9.107 2.92 5.85 4.748 12.11 8.99 18.2 13.44l1.295-.772-13.2-185.441c-27.058 17.74-52.921 34.699-79.377 52.069M479.763 493.5v-67.092c-1.125 1.786-1.512 2.279-1.773 2.831-22.842 48.344-45.668 96.695-68.527 145.03-1.12 2.37-1.387 4.765-.977 7.293.612 3.778 1.267 7.55 1.839 11.334 3.277 21.693 6.679 43.176 15.372 63.76 13.467 31.888 25.417 64.418 37.973 96.69 2.132 5.477 5.173 6.815 12.966 5.34 5.001-.945 3-4.997 3.003-7.695.12-85.497.112-170.994.124-257.491m23.922-39.738-13.455-28.369c-.564 3.251-.266 6.22-.264 9.189.055 105.46.083 210.92.115 316.38 0 1.333.042 2.666.009 3.998-.06 2.405.934 3.54 3.479 3.828 8.668.979 9.858.378 13.043-7.758 11.896-30.388 23.802-60.77 35.644-91.179 3.864-9.922 8.585-19.667 11.043-29.94 3.125-13.06 4.231-26.592 6.431-39.884 1.326-8.009 1.243-15.334-2.547-23.148-18.088-37.305-35.537-74.92-53.498-113.117m83.211 339.636c14.848-16.201 29.638-32.454 44.596-48.553 2.628-2.829 2.868-4.696.403-7.96-19.368-25.638-38.488-51.465-57.717-77.209-4.522-6.054-9.17-12.015-14.36-18.806-3.723 9.528-7.047 18.008-10.35 26.496-11.709 30.081-23.366 60.183-35.179 90.223-1.275 3.244-.378 4.838 2.405 6.389 4.214 2.347 8.21 5.084 12.389 7.498 3.492 2.016 5.306 4.746 5.189 8.911-.168 5.99-.226 11.997.024 17.982.18 4.307-1.378 7.157-5.04 9.474-11.815 7.476-23.426 15.275-35.233 22.765-2.86 1.814-4.136 3.895-4.078 7.295.172 9.99.077 19.983.137 29.974.009 1.439-.347 3.033 1.287 4.456 8.338-1.208 16.453-4.284 24.849-6.154 3.26-.727 5.72-2.194 7.963-4.644 20.694-22.588 41.474-45.096 62.715-68.137M479.738 852.5c-.003-4.83-.184-9.67.053-14.488.168-3.408-1.083-5.514-3.958-7.33-11.965-7.561-23.753-15.402-35.718-22.964-3.6-2.275-5.43-5.032-5.256-9.392.234-5.82.222-11.663.014-17.485-.142-3.965 1.44-6.685 4.705-8.686 4.4-2.697 8.7-5.568 13.17-8.143 2.963-1.708 3.65-3.488 2.313-6.877-12.282-31.115-24.367-62.308-36.524-93.473-2.753-7.058-5.565-14.092-8.312-21.043-2.14.488-2.781 1.755-3.553 2.789-23.022 30.808-45.986 61.66-69.081 92.412-1.984 2.64-2.044 4.238.26 6.7 11.607 12.396 23.032 24.963 34.51 37.48a135162 135162 0 0 1 73.57 80.285c1.626 1.776 3.483 3.054 5.82 3.66 7.893 2.048 15.813 4.002 23.654 6.232 3.678 1.045 4.403-.544 4.346-3.687-.091-4.995-.018-9.993-.013-15.99m316.906-270.693c-10.42-25.587-20.94-51.135-31.164-76.8-1.735-4.356-3.372-4.946-7.622-3.015-38.18 17.353-76.472 34.461-114.712 51.686-2.807 1.264-5.992 1.88-8.954 4.717 65.206 38.974 131.665 74.724 198.074 111.373a669432 669432 0 0 0-35.622-87.961m-481.652-10.355 21.318-12.475c-1.296-.698-1.859-1.048-2.458-1.317-40.884-18.343-81.783-36.652-122.635-55.064-3.589-1.617-4.861-.339-6.18 2.916-21.647 53.409-43.407 106.772-65.105 160.16-.57 1.4-1.792 2.83-.43 5.044 58.192-33.244 117.086-65.068 175.49-99.264m242.286-261.686c-20.668 29.421-41.25 58.903-62.093 88.2-3.269 4.594-4.468 8.439-1.022 13.373 1.78 2.548 2.645 5.726 3.993 8.586 18.24 38.68 36.49 77.354 54.739 116.03l9.705 20.578c.966-14.199 1.77-26.805 2.693-39.403 1.786-24.383 3.706-48.755 5.44-73.142 1.157-16.257 2.229-32.518 3.568-48.765.65-7.881 2.142-15.913.634-23.815-3.987-20.896-8.258-41.738-12.512-62.581-.255-1.251.027-3.04-1.906-3.761a400 400 0 0 1-3.239 4.7m-157.97 38.957c-.395 1.958-.815 3.91-1.181 5.873-1.46 7.836-4.185 15.576-3.842 23.574a1173 1173 0 0 0 3.236 50.323c3.072 35.649 5.374 71.35 7.932 107.035.467 6.517.273 13.161 2.129 20.249.656-1.315 1.024-2.02 1.364-2.74 9.046-19.123 18.072-38.256 27.135-57.372 13.061-27.547 26.062-55.123 39.3-82.585 2.524-5.235 2.226-9.188-1.287-14.063-15-20.815-29.534-41.966-44.257-62.982-6.942-9.91-13.927-19.789-21.473-30.505a17799 17799 0 0 0-9.056 43.193m249.124-71.773 72.706-92.312c-16.063 11.182-31.798 22.637-47.536 34.087-32.85 23.899-65.63 47.897-98.639 71.574-4.589 3.291-5.51 6.544-4.35 11.687 3.033 13.451 5.638 27 8.444 40.502 1.15 5.532 2.377 11.048 3.805 17.663zm-354.51-58.35-44.662-32.467-.312.357 136.983 173.914c2.075-1.94 2.249-3.854 2.605-5.59 3.611-17.593 6.992-35.235 10.8-52.785.97-4.476-.203-6.986-3.821-9.599-33.746-24.367-67.368-48.904-101.593-73.83M466.11 371.432l12.687 18.141.939-.427v-3.358c-.004-29.285-.002-58.57-.018-87.854-.003-5.685-.698-6.178-6.416-5.527-17.334 1.974-34.676 3.876-52.014 5.811-1.598.179-3.388-.133-4.825 2.298 16.3 23.28 32.769 46.803 49.647 70.916m23.901-3.936v21.753l64.314-91.803-64.307-6.974c0 25.848 0 50.937-.007 77.024m32.276 411.626c-3.087-1.96-6.313-3.737-9.23-5.925-4.883-3.664-10.186-5.335-16.306-4.81-6.627.57-13.27.45-19.922.074-7.69-.437-14.548 1.07-21.69 5.075-8.49 4.762-11.24 10.527-10.16 19.576.409 3.42 1.158 5.867 4.157 7.83a1697 1697 0 0 1 32.29 21.68c2.442 1.68 4.215 1.676 6.66-.03 9.679-6.754 19.544-13.24 29.258-19.947 2.538-1.752 6.807-2.877 6.755-6.105-.091-5.64 1.503-11.531-1.812-17.418m86.955-217.835c-4.7.49-9.698-1.626-14.086 1.554-7.149 5.18-14.262 10.411-21.42 15.579-2.151 1.553-3.262 3.466-3.632 6.192-1.051 7.746-2.662 15.42-3.585 23.177-.577 4.843-2.303 9.65-1.348 14.796 1.242 0 2.252.15 3.204-.022 14.568-2.627 29.124-5.317 43.694-7.933 2.577-.462 4.075-1.986 5.156-4.22 5.725-11.843 11.41-23.706 17.281-35.476 1.52-3.045.853-4.636-1.927-6.473-6.846-4.524-14.137-7.268-23.337-7.174M402.62 604.831c-.982-6.405-1.983-12.807-2.934-19.217-.383-2.584-1.412-4.638-3.636-6.231-7.301-5.232-14.48-10.636-21.769-15.886-1.177-.848-2.718-1.864-4.014-1.767-11.116.834-22.707-.733-32.446 7.066-2.804 2.246-4.017 3.683-2.233 7.234 5.823 11.59 11.397 23.305 16.905 35.05 1.21 2.58 2.899 3.566 5.63 4.057 10.957 1.971 21.829 4.425 32.805 6.272 4.62.777 9.252 2.16 14.48 1.844z" />
            </svg>
                                <div class="message-text">
                                    <div class="thinking-dots">
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                    </div>
                                </div>`;
        const incomingMessageDiv = createMessageElement(messageContent,"bot-message","thinking");
        chatBody.appendChild(incomingMessageDiv);
        chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
        saveChatToStorage();
    }, 600);

    userData.file = { data: null, mime_type: null };
}

// --- Send message on Enter ---
messageInput.addEventListener("keydown", (e) => {
    const userMessage = e.target.value.trim();
    if (e.key === "Enter" && userMessage && !e.shiftKey && window.innerWidth > 600) {
        handleOutgoingMessage(e);
    }
});

// --- Auto-resize input ---
messageInput.addEventListener("input", () => {
    const maxHeight = 80;
    messageInput.style.height = `${initialInputHeight}px`;
    messageInput.style.height = `${Math.min(messageInput.scrollHeight, maxHeight)}px`;
    messageInput.style.overflowY = messageInput.scrollHeight > maxHeight ? 'auto' : 'hidden';
    document.querySelector('.chat-form').style.borderRadius = messageInput.scrollHeight > initialInputHeight ? '15px' : '32px';
});

// --- File upload ---
fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        fileUploadWrapper.querySelector('img').src = e.target.result;
        fileUploadWrapper.classList.add('file-uploaded');
        const base64String = e.target.result.split(",")[1];

        userData.file = {
            data: base64String,
            mime_type: file.type
        }
        fileInput.value = "";
    }
    reader.readAsDataURL(file)
});

// --- Cancel file upload ---
fileCancelButton.addEventListener("click", () => {
    userData.file = { data: null, mime_type: null };
    fileUploadWrapper.classList.remove("file-uploaded");
});

// --- Send message button ---
sendMessageButton.addEventListener("click", (e) => handleOutgoingMessage(e));
document.querySelector('#file-upload').addEventListener('click', () => {
    fileInput.click();
});

// --- Chat popup toggle ---
chatbotToggler.addEventListener('click', () => {
    document.body.classList.toggle('show-chatbot');
    saveChatState();
});

closeChatbot.addEventListener('click', () => {
    document.body.classList.remove('show-chatbot');
    saveChatState();
});

// --- Clear chat and show static message with bot avatar ---
addChatBtn.addEventListener('click', () => {
    chatBody.innerHTML = '';
    localStorage.removeItem('chatMessages');

    const staticMessageContent = `<svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="49" viewBox="0 0 928 1024" xml:space="preserve">
                    <path opacity="1.11"
                        d="M198.84 483.132c1.693-28.225 3.298-55.976 5.064-83.716 2.146-33.72 4.539-67.426 6.615-101.15 1.636-26.59 2.867-53.204 4.442-79.797 1.073-18.111 2.395-36.208 3.672-54.307.551-7.815 3.777-9.329 10.223-4.687 12.977 9.346 25.855 18.827 38.783 28.242 45.513 33.147 91.09 66.208 136.466 99.542 5.463 4.014 10.62 1.771 15.766 1.032 20.096-2.887 40.133-6.196 60.174-9.462 6.916-1.127 13.588.492 20.327 1.356 19.15 2.456 38.298 4.941 57.42 7.611 3.797.53 6.4-1.246 9.088-3.202 24.655-17.94 49.292-35.903 73.94-53.852 32.856-23.929 65.722-47.845 98.564-71.794 1.661-1.21 3.317-2.064 5.442-2.174 6.055-.314 6.91.481 7.247 6.492 2.058 36.736 4.121 73.471 6.266 110.202 1.59 27.254 3.283 54.503 4.974 81.752 2.279 36.718 4.596 73.434 6.906 110.15.606 9.629 1.264 19.253 1.865 28.881.115 1.85.51 3.584 1.218 5.313a72218 72218 0 0 1 39.647 97.12c10.994 26.988 21.91 54.01 32.971 80.97 1.748 4.262-.099 6.09-3.748 7.542-16.592 6.604-33.933 10.82-50.971 15.98-42.847 12.975-85.795 25.621-128.634 38.623-6.029 1.83-11.82 4.501-17.971 6.044-2.076.52-3.367 1.991-4.734 3.482-21.049 22.96-42.156 45.866-63.184 68.844a11325 11325 0 0 0-47.39 52.141c-1.987 2.2-4.203 3.594-7.07 4.34-10.957 2.853-21.928 5.672-32.786 8.869-7.225 2.126-13.395-1.578-19.951-2.945-7.32-1.526-14.46-3.902-21.715-5.767-2.862-.737-5.124-2.146-7.112-4.32-24.965-27.29-49.973-54.541-74.966-81.806-12.046-13.141-24.107-26.269-36.097-39.46-1.887-2.076-4.207-3.176-6.738-4.087-17.87-6.437-36.292-11.072-54.432-16.625-46.31-14.174-92.74-27.956-139.116-41.915-6.15-1.852-6.772-3.243-4.237-9.492a272459 272459 0 0 1 52.441-129.146c6.204-15.271 12.197-30.634 18.768-45.746 2.666-6.132 2.236-12.333 2.562-19.078m506.143-34.641 56.8 37.037-19.077-311.097-1.256-.155-154.775 196.402c39.598 26.039 78.654 51.72 118.308 77.813M217.063 347.394c-1.365 22.756-2.684 45.515-4.114 68.268-.792 12.615-2.059 25.207-2.577 37.832-.433 10.536-1.776 21.054-1.264 32.622l174.059-114.051-155.556-197.313c-.527 7.048-1.019 12.62-1.348 18.203-1.147 19.433-2.193 38.873-3.36 58.306-1.905 31.725-3.875 63.446-5.84 96.133m414 256.064c-2.316 4.795-4.675 9.57-6.933 14.394-1.454 3.105-3.714 4.93-7.152 5.536-8.68 1.53-17.335 3.208-26 4.826-8.067 1.506-16.134 3.011-24.746 4.62 1.23 1.974 1.922 3.293 2.803 4.47 23.539 31.467 47.132 62.893 70.595 94.416 2.212 2.972 4.14 3.776 7.865 2.654 55.597-16.748 111.251-33.305 166.883-49.939 4.466-1.335 8.864-2.9 14.07-4.614-61.561-35.05-122.848-68.568-183.852-104.096-4.628 9.487-8.915 18.275-13.534 27.733m-385.656 18.52c-34.166 19.242-68.333 38.483-102.718 57.846 2.1 2.092 4.346 2.232 6.362 2.84 22.784 6.872 45.583 13.695 68.375 20.545 34.592 10.396 69.203 20.729 103.744 31.295 4.373 1.338 6.843.53 9.585-3.169 20.738-27.965 41.706-55.759 62.586-83.618 3.354-4.474 6.628-9.007 10.215-13.888-1.966-.601-3.184-1.108-4.452-1.34-15.052-2.77-30.1-5.57-45.177-8.19-4.117-.714-6.802-2.475-8.632-6.465-5.552-12.106-11.648-23.962-17.227-36.056-2.074-4.496-4.205-4.86-8.329-2.39-24.29 14.552-48.895 28.56-74.332 42.59m359.437-70.262c3.991.164 8.025.029 11.96.583 3.295.464 6.16.032 9.167-1.323 38.853-17.5 77.754-34.892 116.599-52.41 3.868-1.745 8.039-3.003 12.15-6.117l-169.91-111.566-13.49 187.613c6.892-4.96 12.936-8.553 18.02-13.196 4.5-4.108 9.063-5.068 15.504-3.584M305.58 434.128l-90.107 59.353c.884.801 1.084 1.094 1.36 1.218q64.023 28.784 128.057 57.543c2.15.966 4.317 1.5 6.77 1.236 5.951-.643 11.94-.953 17.895-1.566 3.534-.363 6.277.625 9.107 2.92 5.85 4.748 12.11 8.99 18.2 13.44l1.295-.772-13.2-185.441c-27.058 17.74-52.921 34.699-79.377 52.069M479.763 493.5v-67.092c-1.125 1.786-1.512 2.279-1.773 2.831-22.842 48.344-45.668 96.695-68.527 145.03-1.12 2.37-1.387 4.765-.977 7.293.612 3.778 1.267 7.55 1.839 11.334 3.277 21.693 6.679 43.176 15.372 63.76 13.467 31.888 25.417 64.418 37.973 96.69 2.132 5.477 5.173 6.815 12.966 5.34 5.001-.945 3-4.997 3.003-7.695.12-85.497.112-170.994.124-257.491m23.922-39.738-13.455-28.369c-.564 3.251-.266 6.22-.264 9.189.055 105.46.083 210.92.115 316.38 0 1.333.042 2.666.009 3.998-.06 2.405.934 3.54 3.479 3.828 8.668.979 9.858.378 13.043-7.758 11.896-30.388 23.802-60.77 35.644-91.179 3.864-9.922 8.585-19.667 11.043-29.94 3.125-13.06 4.231-26.592 6.431-39.884 1.326-8.009 1.243-15.334-2.547-23.148-18.088-37.305-35.537-74.92-53.498-113.117m83.211 339.636c14.848-16.201 29.638-32.454 44.596-48.553 2.628-2.829 2.868-4.696.403-7.96-19.368-25.638-38.488-51.465-57.717-77.209-4.522-6.054-9.17-12.015-14.36-18.806-3.723 9.528-7.047 18.008-10.35 26.496-11.709 30.081-23.366 60.183-35.179 90.223-1.275 3.244-.378 4.838 2.405 6.389 4.214 2.347 8.21 5.084 12.389 7.498 3.492 2.016 5.306 4.746 5.189 8.911-.168 5.99-.226 11.997.024 17.982.18 4.307-1.378 7.157-5.04 9.474-11.815 7.476-23.426 15.275-35.233 22.765-2.86 1.814-4.136 3.895-4.078 7.295.172 9.99.077 19.983.137 29.974.009 1.439-.347 3.033 1.287 4.456 8.338-1.208 16.453-4.284 24.849-6.154 3.26-.727 5.72-2.194 7.963-4.644 20.694-22.588 41.474-45.096 62.715-68.137M479.738 852.5c-.003-4.83-.184-9.67.053-14.488.168-3.408-1.083-5.514-3.958-7.33-11.965-7.561-23.753-15.402-35.718-22.964-3.6-2.275-5.43-5.032-5.256-9.392.234-5.82.222-11.663.014-17.485-.142-3.965 1.44-6.685 4.705-8.686 4.4-2.697 8.7-5.568 13.17-8.143 2.963-1.708 3.65-3.488 2.313-6.877-12.282-31.115-24.367-62.308-36.524-93.473-2.753-7.058-5.565-14.092-8.312-21.043-2.14.488-2.781 1.755-3.553 2.789-23.022 30.808-45.986 61.66-69.081 92.412-1.984 2.64-2.044 4.238.26 6.7 11.607 12.396 23.032 24.963 34.51 37.48a135162 135162 0 0 1 73.57 80.285c1.626 1.776 3.483 3.054 5.82 3.66 7.893 2.048 15.813 4.002 23.654 6.232 3.678 1.045 4.403-.544 4.346-3.687-.091-4.995-.018-9.993-.013-15.99m316.906-270.693c-10.42-25.587-20.94-51.135-31.164-76.8-1.735-4.356-3.372-4.946-7.622-3.015-38.18 17.353-76.472 34.461-114.712 51.686-2.807 1.264-5.992 1.88-8.954 4.717 65.206 38.974 131.665 74.724 198.074 111.373a669432 669432 0 0 0-35.622-87.961m-481.652-10.355 21.318-12.475c-1.296-.698-1.859-1.048-2.458-1.317-40.884-18.343-81.783-36.652-122.635-55.064-3.589-1.617-4.861-.339-6.18 2.916-21.647 53.409-43.407 106.772-65.105 160.16-.57 1.4-1.792 2.83-.43 5.044 58.192-33.244 117.086-65.068 175.49-99.264m242.286-261.686c-20.668 29.421-41.25 58.903-62.093 88.2-3.269 4.594-4.468 8.439-1.022 13.373 1.78 2.548 2.645 5.726 3.993 8.586 18.24 38.68 36.49 77.354 54.739 116.03l9.705 20.578c.966-14.199 1.77-26.805 2.693-39.403 1.786-24.383 3.706-48.755 5.44-73.142 1.157-16.257 2.229-32.518 3.568-48.765.65-7.881 2.142-15.913.634-23.815-3.987-20.896-8.258-41.738-12.512-62.581-.255-1.251.027-3.04-1.906-3.761a400 400 0 0 1-3.239 4.7m-157.97 38.957c-.395 1.958-.815 3.91-1.181 5.873-1.46 7.836-4.185 15.576-3.842 23.574a1173 1173 0 0 0 3.236 50.323c3.072 35.649 5.374 71.35 7.932 107.035.467 6.517.273 13.161 2.129 20.249.656-1.315 1.024-2.02 1.364-2.74 9.046-19.123 18.072-38.256 27.135-57.372 13.061-27.547 26.062-55.123 39.3-82.585 2.524-5.235 2.226-9.188-1.287-14.063-15-20.815-29.534-41.966-44.257-62.982-6.942-9.91-13.927-19.789-21.473-30.505a17799 17799 0 0 0-9.056 43.193m249.124-71.773 72.706-92.312c-16.063 11.182-31.798 22.637-47.536 34.087-32.85 23.899-65.63 47.897-98.639 71.574-4.589 3.291-5.51 6.544-4.35 11.687 3.033 13.451 5.638 27 8.444 40.502 1.15 5.532 2.377 11.048 3.805 17.663zm-354.51-58.35-44.662-32.467-.312.357 136.983 173.914c2.075-1.94 2.249-3.854 2.605-5.59 3.611-17.593 6.992-35.235 10.8-52.785.97-4.476-.203-6.986-3.821-9.599-33.746-24.367-67.368-48.904-101.593-73.83M466.11 371.432l12.687 18.141.939-.427v-3.358c-.004-29.285-.002-58.57-.018-87.854-.003-5.685-.698-6.178-6.416-5.527-17.334 1.974-34.676 3.876-52.014 5.811-1.598.179-3.388-.133-4.825 2.298 16.3 23.28 32.769 46.803 49.647 70.916m23.901-3.936v21.753l64.314-91.803-64.307-6.974c0 25.848 0 50.937-.007 77.024m32.276 411.626c-3.087-1.96-6.313-3.737-9.23-5.925-4.883-3.664-10.186-5.335-16.306-4.81-6.627.57-13.27.45-19.922.074-7.69-.437-14.548 1.07-21.69 5.075-8.49 4.762-11.24 10.527-10.16 19.576.409 3.42 1.158 5.867 4.157 7.83a1697 1697 0 0 1 32.29 21.68c2.442 1.68 4.215 1.676 6.66-.03 9.679-6.754 19.544-13.24 29.258-19.947 2.538-1.752 6.807-2.877 6.755-6.105-.091-5.64 1.503-11.531-1.812-17.418m86.955-217.835c-4.7.49-9.698-1.626-14.086 1.554-7.149 5.18-14.262 10.411-21.42 15.579-2.151 1.553-3.262 3.466-3.632 6.192-1.051 7.746-2.662 15.42-3.585 23.177-.577 4.843-2.303 9.65-1.348 14.796 1.242 0 2.252.15 3.204-.022 14.568-2.627 29.124-5.317 43.694-7.933 2.577-.462 4.075-1.986 5.156-4.22 5.725-11.843 11.41-23.706 17.281-35.476 1.52-3.045.853-4.636-1.927-6.473-6.846-4.524-14.137-7.268-23.337-7.174M402.62 604.831c-.982-6.405-1.983-12.807-2.934-19.217-.383-2.584-1.412-4.638-3.636-6.231-7.301-5.232-14.48-10.636-21.769-15.886-1.177-.848-2.718-1.864-4.014-1.767-11.116.834-22.707-.733-32.446 7.066-2.804 2.246-4.017 3.683-2.233 7.234 5.823 11.59 11.397 23.305 16.905 35.05 1.21 2.58 2.899 3.566 5.63 4.057 10.957 1.971 21.829 4.425 32.805 6.272 4.62.777 9.252 2.16 14.48 1.844z" />
                </svg>
                                    <div class="message-text">
                                    ${staticMessage.innerHTML}
                                    </div>`;
    const staticMessageDiv = createMessageElement(staticMessageContent, "bot-message");
    chatBody.appendChild(staticMessageDiv);
    chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });

    saveChatToStorage();
});

// --- Load chat and popup state on page load ---
window.addEventListener('DOMContentLoaded', () => {
    loadChatFromStorage();
    loadChatState();
});